<!DOCTYPE html>
<html>
<head>
  <title>SSE Test</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    #log { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: scroll; }
    .event { margin: 5px 0; padding: 5px; background: #f5f5f5; }
    .connected { background: #d4edda; }
    .progress { background: #cce5ff; }
    .status { background: #fff3cd; }
    button { margin: 5px; padding: 10px; }
  </style>
</head>
<body>
  <h1>Server-Sent Events Test</h1>

  <div>
    <input type="text" id="jobId" placeholder="Enter Job ID" style="width: 300px; padding: 5px;" />
    <button onclick="startSSE()">Connect to Job Stream</button>
    <button onclick="stopSSE()">Disconnect</button>
    <button onclick="createJob()">Create Test Job</button>
  </div>

  <h2>Event Log:</h2>
  <div id="log"></div>

  <script>
    let eventSource = null;

    function log(message, className = '') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'event ' + className;
      entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function createJob() {
      try {
        const response = await fetch('http://localhost:3000/api/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: 'SSE Test Job' })
        });
        const data = await response.json();
        log('Job created: ' + data.job.id, 'connected');
        document.getElementById('jobId').value = data.job.id;
      } catch (error) {
        log('Error creating job: ' + error.message);
      }
    }

    function startSSE() {
      const jobId = document.getElementById('jobId').value;
      if (!jobId) {
        alert('Please enter a Job ID');
        return;
      }

      if (eventSource) {
        eventSource.close();
      }

      log('Connecting to job stream: ' + jobId, 'connected');
      eventSource = new EventSource(`http://localhost:3000/api/jobs/${jobId}/stream`);

      eventSource.onopen = () => {
        log('✅ SSE connection opened', 'connected');
      };

      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);

          if (data.type === 'connected') {
            log(`Connected to job ${data.jobId}`, 'connected');
          } else if (data.type === 'progress') {
            log(`Progress: ${data.progress}% - ${data.action}`, 'progress');
          } else if (data.type === 'status') {
            log(`Status: ${data.status} (${data.progress}%)`, 'status');
          } else if (data.type === 'error') {
            log(`Error: ${data.message}`, 'status');
          }
        } catch (error) {
          log('Received: ' + event.data);
        }
      };

      eventSource.onerror = (error) => {
        log('❌ SSE error or connection closed');
        eventSource.close();
        eventSource = null;
      };
    }

    function stopSSE() {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
        log('Disconnected from job stream', 'status');
      }
    }
  </script>
</body>
</html>
